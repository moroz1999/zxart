<ng-container *ngIf="state$ | async as state">
  <zx-panel @slideUp padding="sm" radius="lg" variant="elevated" class="player-panel">
    <div class="player-bar">
      <div class="player-controls">
        <zx-button
          size="sm"
          color="transparent"
          [round]="true"
          [disabled]="state.mode === 'radio'"
          [ariaLabel]="'player.controls.previous' | translate"
          (click)="previous()"
        >
          <mat-icon>skip_previous</mat-icon>
        </zx-button>
        <zx-button
          size="sm"
          color="secondary"
          [round]="true"
          [ariaLabel]="state.isPlaying ? ('player.controls.pause' | translate) : ('player.controls.play' | translate)"
          (click)="togglePlay()"
        >
          <mat-icon>{{ state.isPlaying ? 'pause' : 'play_arrow' }}</mat-icon>
        </zx-button>
        <zx-button
          size="sm"
          color="transparent"
          [round]="true"
          [disabled]="state.currentIndex < 0"
          [ariaLabel]="'player.controls.stop' | translate"
          (click)="stop()"
        >
          <mat-icon>stop</mat-icon>
        </zx-button>
        <zx-button
          size="sm"
          color="transparent"
          [round]="true"
          [ariaLabel]="'player.controls.next' | translate"
          (click)="next()"
        >
          <mat-icon>skip_next</mat-icon>
        </zx-button>
      </div>

      <div
        class="player-progress"
        [class.player-progress--disabled]="state.currentIndex < 0"
        [style.--zx-player-progress]="getProgressPercent(state)"
        (click)="seekByClick($event, state.duration)"
      >
        <span zxBody class="player-progress-text">{{ getCurrentTitle(state) }}</span>
      </div>

      <zx-button
        size="sm"
        color="transparent"
        [round]="true"
        [ariaLabel]="'player.controls.mode' | translate"
        (click)="cyclePlaybackMode(state)"
      >
        <mat-icon>{{ getPlaybackModeIcon(state) }}</mat-icon>
      </zx-button>

      <zx-button
        size="sm"
        color="transparent"
        [round]="true"
        [disabled]="state.currentIndex < 0 || !state.playlist[state.currentIndex].url"
        [ariaLabel]="'player.controls.open' | translate"
        (click)="openCurrentTuneUrl()"
      >
        <mat-icon>open_in_new</mat-icon>
      </zx-button>

      <zx-rating
        *ngIf="state.playlist[state.currentIndex] as tune"
        class="player-rating"
        [overallRating]="tune.votes"
        [userRating]="tune.userVote ?? undefined"
        (voted)="vote($event)"
      ></zx-rating>

      <zx-button
        size="sm"
        color="transparent"
        [round]="true"
        [ariaLabel]="expanded ? ('player.controls.collapse' | translate) : ('player.controls.expand' | translate)"
        (click)="toggleExpanded()"
      >
        <mat-icon>{{ expanded ? 'expand_more' : 'expand_less' }}</mat-icon>
      </zx-button>

      <zx-button
        size="sm"
        color="transparent"
        [round]="true"
        [ariaLabel]="'player.controls.close' | translate"
        (click)="close()"
      >
        <mat-icon>close</mat-icon>
      </zx-button>
    </div>

    <div class="player-advanced" *ngIf="expanded" @expandPanel>
      <form [formGroup]="form" class="player-advanced-form">
        <zx-skeleton *ngIf="optionsLoading" variant="text" [count]="3"></zx-skeleton>

        <div class="player-error" *ngIf="optionsError">
          <span zxBody>{{ 'player.filters.loadError' | translate }}</span>
        </div>

        <div class="player-presets" *ngIf="options && !optionsLoading">
          <zx-button
            *ngFor="let preset of presets"
            size="sm"
            color="outlined"
            [extraClass]="activePreset === preset.key ? 'player-preset-active' : ''"
            (click)="applyPreset(preset.key)"
          >
            {{ preset.label | translate }}
          </zx-button>
        </div>

        <div class="player-advanced-grid" *ngIf="options && !optionsLoading">
          <div class="player-field player-field--range" *ngIf="hasRatingRange">
            <div class="player-field-label-row">
              <span zxCaption class="player-field-label">{{ 'player.filters.minRating' | translate }}</span>
              <span zxCaption class="player-field-value">{{ getRatingDisplayValue() }}</span>
            </div>
            <zx-input-range
              [min]="ratingMin"
              [max]="ratingMax"
              [step]="0.1"
              formControlName="minRating"
            ></zx-input-range>
          </div>
          <div class="player-field">
            <span zxCaption class="player-field-label">{{ 'player.filters.category' | translate }}</span>
            <zx-select
              [options]="categoryOptions"
              formControlName="category"
            ></zx-select>
          </div>
          <div class="player-field">
            <span zxCaption class="player-field-label">{{ 'player.filters.minPartyPlace' | translate }}</span>
            <zx-input
              type="number"
              [min]="0"
              [step]="1"
              formControlName="minPartyPlace"
            ></zx-input>
          </div>
          <div class="player-field player-field--range" *ngIf="hasYearRange">
            <div class="player-field-label-row">
              <span zxCaption class="player-field-label">{{ 'player.filters.yearFrom' | translate }}</span>
              <span zxCaption class="player-field-label">{{ 'player.filters.yearTo' | translate }}</span>
            </div>
            <zx-min-max-range
              [min]="yearMin"
              [max]="yearMax"
              [step]="1"
              formControlName="yearRange"
            ></zx-min-max-range>
          </div>
          <div class="player-field">
            <zx-filter-picker
              [label]="'player.filters.countries' | translate"
              [items]="countryItems"
              [selectedIds]="selectedCountries"
              [placeholder]="'player.filters.any' | translate"
              [searchEnabled]="true"
              [multi]="true"
              (selectedIdsChange)="onCountriesChange($event)"
            ></zx-filter-picker>
          </div>
          <div class="player-field">
            <zx-filter-picker
              [label]="'player.filters.soundGroups' | translate"
              [items]="formatGroupItems"
              [selectedIds]="selectedFormatGroups"
              [placeholder]="'player.filters.any' | translate"
              [searchEnabled]="true"
              [multi]="true"
              (selectedIdsChange)="onFormatGroupsChange($event)"
            ></zx-filter-picker>
          </div>
          <div class="player-field">
            <span zxCaption class="player-field-label">{{ 'player.filters.formats' | translate }}</span>
            <zx-select
              [options]="formatOptions"
              [multiple]="true"
              [listSize]="3"
              formControlName="formats"
            ></zx-select>
          </div>
          <div class="player-field">
            <span zxCaption class="player-field-label">{{ 'player.filters.party' | translate }}</span>
            <zx-select
              [options]="partyOptions"
              formControlName="party"
            ></zx-select>
          </div>
          <div class="player-field">
            <zx-checkbox-field
              [label]="'player.filters.unvotedOnly' | translate"
              formControlName="unvotedOnly"
            ></zx-checkbox-field>
          </div>
        </div>
      </form>
    </div>
  </zx-panel>
</ng-container>
